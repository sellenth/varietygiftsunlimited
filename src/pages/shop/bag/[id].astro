---
import Layout from "../../../layouts/Layout.astro";
export const prerender = true;
import ImageCarousel from "../../../components/ImageCarousel.astro"; // Assuming a carousel might be nice
import { bagNames, disabledBags, onModelPhotos } from "../../../data/bagsData"; // Import from the new data file

// Define the props type for better type checking (optional but good practice)
interface Props {
    id: number;
    title: string;
    description: string;
    images: { src: string, alt: string }[];
    priceDisplay: string;
    priceId: string;
    clientReferenceId: string;
}

export async function getStaticPaths() {
    // Generate paths for bags 1 through 13
    const paths = Array.from({ length: 13 }, (_, i) => {
        const bagNum = i + 1;
        const images = [{ src: `/bags/${bagNum}.webp`, alt: `Crochet Bag #${bagNum}` }];

        // Add on-model photo if available
        if (onModelPhotos[bagNum]) {
            images.push({ src: onModelPhotos[bagNum], alt: `${bagNames[i]} - On Model` });
        }

        return {
            params: { id: bagNum.toString() },
            props: {
                id: bagNum,
                title: bagNames[i],
                description: "A beautiful, handmade crochet bag. Perfect for carrying your essentials.",
                images,
                priceDisplay: "$29.99", // Adjust if needed
                priceId: "price_1R88KsAp2D4XT14xnjBjFhmd",
                clientReferenceId: `bag-${bagNum}`
            } satisfies Props // Ensure props match the interface
        };
    });
    return paths;
}

// Explicitly type Astro.props
const { id, title, description, images, priceDisplay, priceId, clientReferenceId } = Astro.props as Props;
const PUBLIC_STRIPE_KEY = import.meta.env.PUBLIC_STRIPE_KEY;
const isDisabled = disabledBags.includes(id);

// Get the canonical URL for this bag
const canonicalUrl = `https://www.variety.gifts/shop/bag/${id}`;

// Get the first image for social media preview
const ogImageUrl = images[0]?.src.startsWith('http') 
    ? images[0].src 
    : `https://www.variety.gifts${images[0]?.src}`;
---


<Layout 
    title={`${title} - Variety Gifts Unlimited`} 
    hideHeader={false}
    description={description}
    ogTitle={`${title} - ${priceDisplay}`}
    ogDescription={description}
    ogImage={ogImageUrl}
    ogUrl={canonicalUrl}
>
    <div class="max-w-6xl mx-auto px-4 py-8">
        <button onclick="window.history.length > 1 ? history.back() : window.location.href = '/'" class="inline-block mb-6 text-gray-600 hover:text-gray-900 transition-colors">
            <span class="flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back
            </span>
        </button>
        <div class="grid md:grid-cols-2 gap-8">
            <!-- Use ImageCarousel or a simple img tag -->
            <ImageCarousel images={images} title={title} />
            <!-- Or: <img src={images[0]} alt={title} class="w-full h-auto object-cover rounded-lg shadow-md"/> -->
            
            <div class="flex flex-col gap-4">
                <h1 class="text-3xl font-bold">{title}</h1>
                <p class="text-gray-600">{description}</p>

                <div class="space-y-4">
                    <p class="text-xl font-semibold">{priceDisplay} w/ free shipping!</p>
                    {isDisabled ? (
                        <>
                            <button class="w-full bg-gray-300 text-gray-600 py-3 px-6 rounded-md cursor-not-allowed" disabled aria-disabled="true">Unavailable</button>
                            <p class="text-sm text-center text-gray-500">This item is currently unavailable.</p>
                        </>
                    ) : (
                        <>
                            <button 
                                id="buy-button"
                                data-stripe-key={PUBLIC_STRIPE_KEY}
                                data-stripe-price-id={priceId}
                                data-client-reference-id={clientReferenceId}
                                class="w-full bg-indigo-600 text-white py-3 px-6 rounded-md hover:bg-indigo-700 transition-colors"
                            >
                                Buy Now
                            </button>
                            <p class="text-sm text-center text-gray-500">Powered by Stripe</p>
                        </>
                    )}
                </div>
            </div>
        </div>
    </div>

    <script>
        import { loadStripe } from "@stripe/stripe-js";

        const buyButton = document.getElementById("buy-button") as HTMLButtonElement | null;
        const CHECKOUT_ENDPOINT = "/shop/checkout";

        if (!buyButton) {
            console.error("Buy button not found.");
        } else if (!buyButton.dataset.stripeKey || !buyButton.dataset.stripePriceId || !buyButton.dataset.clientReferenceId) {
            console.error("Missing required Stripe configuration on button");
            buyButton.disabled = true;
        } else {
            const stripeKey = buyButton.dataset.stripeKey;
            const priceId = buyButton.dataset.stripePriceId;
            const clientReferenceId = buyButton.dataset.clientReferenceId;
            let stripe: any = null;

            const initializeStripe = async () => {
                if (!stripe) {
                    if (typeof window.Stripe === 'function') {
                        stripe = window.Stripe(stripeKey);
                    } else {
                        const stripeModule = await loadStripe(stripeKey);
                        if (!stripeModule) {
                            throw new Error("loadStripe returned null.");
                        }
                        stripe = stripeModule;
                    }
                }
                if (!stripe) {
                    console.error("Failed to initialize Stripe.");
                    buyButton.disabled = true;
                    throw new Error("Failed to initialize Stripe.");
                }
                return stripe;
            };

            const createCheckoutSession = async () => {
                const endpointUrl = new URL(CHECKOUT_ENDPOINT, window.location.origin).toString();
                const payload = {
                    priceId,
                    clientReferenceId,
                    successUrl: `${window.location.origin}/success`,
                    cancelUrl: window.location.href
                };

                const response = await fetch(endpointUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data?.error || "Failed to create checkout session.");
                }

                if (!data?.sessionId) {
                    throw new Error("Checkout session response missing sessionId.");
                }

                return data.sessionId as string;
            };

            const setProcessingState = (isProcessing: boolean) => {
                if (!buyButton) return;
                if (isProcessing) {
                    buyButton.dataset.originalLabel = buyButton.textContent || "Buy Now";
                    buyButton.textContent = "Processing...";
                    buyButton.disabled = true;
                } else {
                    buyButton.textContent = buyButton.dataset.originalLabel || "Buy Now";
                    buyButton.disabled = false;
                }
            };

            buyButton.addEventListener("click", async () => {
                if (!priceId) {
                    alert("Missing price information. Please refresh the page.");
                    return;
                }

                setProcessingState(true);

                try {
                    const sessionId = await createCheckoutSession();
                    const stripeInstance = await initializeStripe();
                    const result = await stripeInstance.redirectToCheckout({ sessionId });

                    if (result && result.error) {
                        console.error("Stripe checkout failed:", result.error);
                        alert(result.error.message || "Checkout failed. Please try again.");
                    }
                } catch (error) {
                    console.error("Stripe initialization or checkout failed:", error);
                    alert("Could not start checkout. Please refresh the page or try again later.");
                } finally {
                    setProcessingState(false);
                }
            });
        }
    </script> 
</Layout> 
