<head>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
  />

  <script src="/a-frame/aframe-master.min.js" is:inline></script>
  <script src="https://unpkg.com/openai-realtime-api@latest/dist/browser.js"></script>

  <script>
    if (!window.isSecureContext) {
      alert("WebXR needs HTTPS");
    }
    var openai_key = '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'

    // Initialize the Realtime client
    const client = new RealtimeClient({
      apiKey: openai_key,
      sessionConfig: {
        instructions: "You are a friendly robot assistant. Keep your responses brief and engaging.",
        voice: 'alloy',
        input_audio_transcription: { model: 'whisper-1' }
      }
    });

    // Handle responses to update the robot's text
    client.on('response.text.delta', (event) => {
      const textElement = document.querySelector('a-text');
      textElement.setAttribute('value', event.text);
    });

    // Setup voice capture
    async function setupVoiceCapture() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioContext = new AudioContext();
        const source = audioContext.createMediaStreamSource(stream);
        const processor = audioContext.createScriptProcessor(1024, 1, 1);
        
        processor.onaudioprocess = function(e) {
          if (!client.isConnected) return;
          
          try {
            const inputData = e.inputBuffer.getChannelData(0);
            const base64Audio = floatTo16BitPCM(inputData);
            
            client.sendAudioBuffer(base64Audio);
          } catch (error) {
            console.error("Error sending audio data:", error);
          }
        };

        source.connect(processor);
        processor.connect(audioContext.destination);
      } catch (error) {
        console.error("Error accessing microphone:", error);
      }
    }

    // Initialize connection and setup
    async function initialize() {
      try {
        await client.connect();
        console.log("Connected to OpenAI Realtime API");
        await setupVoiceCapture();
      } catch (error) {
        console.error("Error initializing:", error);
      }
    }

    // Start everything when the page loads
    window.addEventListener('load', initialize);

    // Helper function to convert audio format
    function floatTo16BitPCM(float32Array) {
      const buffer = new ArrayBuffer(float32Array.length * 2);
      const view = new DataView(buffer);
      for (let i = 0; i < float32Array.length; i++) {
        const s = Math.max(-1, Math.min(1, float32Array[i]));
        view.setInt16(i * 2, s < 0 ? s * 0x8000 : s * 0x7fff, true);
      }
      return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }
  </script>
</head>
<div>
  <a-scene
  >
    <!-- Add assets management system -->
    <a-assets>
      <a-asset-item id="robot" src="/a-frame/robot.glb"></a-asset-item>
    </a-assets>

    <a-sky color="#87CEEB"></a-sky>
    <a-plane 
      position="0 0 0" 
      rotation="-90 0 0" 
      width="30" 
      height="30" 
      color="#8B4513"
      shadow="receive: true"
    ></a-plane>

    <!-- Robot with floating text above it -->
    <a-entity position="0 0 -3" scale="0.5 0.5 0.5">
      <!-- Robot model -->
      <a-entity
        gltf-model="#robot"
        scale="0.5 0.5 0.5"
        animation-mixer
        shadow="cast: true"
      ></a-entity>

      <a-entity position="0 2.5 0">
        <a-text
          value="Hi"
          scale="2 2 2"
          color="#000000"
          align="center"
          side="double"
          billboard
        ></a-text>
      </a-entity>
    </a-entity>

    <a-entity position="0 0 0">
      <a-camera id="camera"></a-camera>
    </a-entity>

    <a-entity
      id="rightHand"
      hand-tracking-grab-controls="hand: right"
      coffee-spawner="targetElementSelector: [data-world-mesh=table]"
    ></a-entity>
    <a-entity
      id="leftHand"
      hand-tracking-grab-controls="hand: left"
      coffee-spawner="targetElementSelector: [data-world-mesh=table]"
    ></a-entity>
  </a-scene>
</div>
